<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>متابعة نواقص الفروع | Branch Shortage Tracking</title>
<style>
  /* نفس التنسيقات السابقة */
  body { font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; background: #f4f4f4; direction: rtl;}
  header {background: #fff; padding: 20px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); font-size: 1.3rem;}
  .branches-container {display: flex; gap: 10px; padding: 20px;}
  .branch-section {flex: 1; background: #fff; padding: 15px; border-radius: 8px; max-height: 80vh; overflow-y: auto; box-shadow: 0 2px 4px rgba(0,0,0,0.1);}
  .branch-section h2 {text-align: center; margin-top: 0;}
  .product-card {border: 1px solid #ccc; padding: 10px; border-radius: 6px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;}
  .product-card.red {background-color: #fdd;}
  .product-card.green {background-color: #dfd;}
  .product-info {text-align: right; max-width: 60%;}
  .product-info span {display: inline-block; margin-left: 8px; font-style: italic; color: #555; font-size: 0.9rem;}
  .product-info .date {font-size: 0.75rem; color: #333; margin-top: 4px;}
  .product-actions {display: flex; align-items: center; gap: 10px;}
  .editable-added {width: 60px; padding: 3px 6px; font-size: 0.9rem; border-radius: 4px; border: 1px solid #ccc; text-align: center;}
  .whatsapp-btn {margin-top: 10px; background: #25d366; color: white; border: none; padding: 12px; font-size: 1rem; border-radius: 8px; cursor: pointer; width: 90%; max-width: 250px; display: block; margin-left: auto; margin-right: auto;}
</style>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBoUv5YTd2ZalQ_mdkOVZF13ps_XYvmtBk",
    authDomain: "shortage-tracker-f0054.firebaseapp.com",
    databaseURL: "https://shortage-tracker-f0054-default-rtdb.firebaseio.com",
    projectId: "shortage-tracker-f0054",
    storageBucket: "shortage-tracker-f0054.appspot.com",
    messagingSenderId: "61596664058",
    appId: "1:61596664058:web:77ee76208afe58a0b20943"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const translations = {
 "كعك فلسطيني": "Palestinian Kaak (½ kg)",
  "معمول تمر الحبوب الاربعة حبوب كاملة": "Date Maamoul with Four Whole Grains",
  "معمول تمر نجوم وهلال": "Date Ma'amoul in Star and Crescent Shapes",
  "معمول السندويشة": "Sandwich Maamoul",
  "معمول تمر نباتى": "Vegan Date Maamoul",
  "معمول التمر بالجوز": "Date and Walnut Maamoul",
  "معمول الشوفان": "Oatmeal Ma'amoul (1/2 kg)",
  "نصف كيلو معمول أصابع": "Maamoul Fingers (½ kg)",
  "قراقيش السماق": "Sumac Crackers",
  "قراقيش الكركم": "Turmeric Crackers",
  "قراقيش الشعير بالزعتر الاخضر": "Barley Crackers with Fresh Thyme",
  "قراقيش محمرة بالشمندر": "Beetroot Toast Crackers",
  "قراقيش الزعتر بزيت الزيتون": "Thyme Olive Oil Crackers",
  "قراقيش بصل اخضر و زيتون": "Spring Onion and Olive Crackers",
  "قراقيش الخضار بالثوم": "Vegetable Crackers with Garlic",
  "العصا الايطالي بالكينوا وبذور الشيا": "Italian Sticks with Quinoa and Chia Seeds",
  "عصا الخبز الايطالي بالزعتر": "Italian Breadsticks with Thyme",
  "عصا الخبز الايطالي بالحبوب الخمسة": "Italian Breadsticks with Five Grains",
  "عصا الخبز الايطالى بالشوفان واليانسون": "Oatmeal and Anise Italian Breadsticks",
  "شابورة جوز الهند": "Coconut Rusk",
  "شابورة الفواكة المجففة": "Rusk with Dried Fruits",
  "شابورة حبوب الدخن الخالية من الجلوتين": "Gluten-Free Millet Rusks",
  "بقصم الينسون": "Anise Rusks",
  "بقصم الزعتر": "Thyme Rusks",
  "بقصم لسان الثور": "Bull's Tongue Rusks",
  "حلقات الشيكولاتة الداكنة": "Dark Chocolate Rings",
  "بسكويت حلقات المربى (4حبات)": "Jam-Filled Biscuit Rings (4 Pieces)",
  "بسكويت الشيكولاتة بجوز الهند حبوب كاملة": "Whole Grain Chocolate and Coconut Biscuits",
  "حلقات السمسمية": "Sesame Rings",
  "حلقات السمسمية بالشيكولاتة": "Sesame Chocolate Rings",
  "كرات السمسم": "Sesame Balls",
  "كرات الشيكولاتة بالعسل والمكسرات": "Chocolate Balls with Honey and Nuts",
  "كرات الشيكولاتة بالمكسرات كيتو": "Keto Chocolate Nut Balls",
  "كوكيز الشوفان واللوز": "Oat and Almond Cookies",
  "كوكيز الشيكولاتة باليقطين والشوفان واللوز والفول": "Pumpkin and Almond Chocolate Cookies",
  "كوكيز كيتو": "Keto Cookies",
  "بسكويت تركي بالحنطة": "Turkish Biscuits with Barley and Black Seeds",
  "بسكويت تركي بالجاودر": "Turkish Biscuits with Caraway and Pumpkin Seeds",
  "بسكويت تركي بالشعير": "Turkish Barley Biscuits with Pumpkin and Sunflower Seeds",
  "بسكويت اليانسون حبوب كاملة": "Whole Grain Anise Biscuits",
  "بسكويت اليانسون النباتى": "Vegan Anise Biscuits",
  "بسكويت الدارسين حبوب كاملة": "Whole Grain Cinnamon Biscuits",
  "بسكويت قشر الليمون والبرتقال": "Lemon and Orange Peel Biscuits",
  "بسكويت الهيل": "Cardamom Biscuits",
  "بسكويت الزعتر بالحبوب الكاملة والخميرة الطبيعية": "Whole Grain Thyme Biscuits with Natural Yeast",
  "بسكويت ببذور الشيا": "Chia Seed Biscuits",
  "بسكويت بذور الكتان المبرعم": "Sprouted Flax Seed Biscuits",
  "بسكويت الحبوب الستة بالحبوب الكاملة": "Six-Grain Biscuits with Natural Yeast",
  "مقرمشات الحبوب المنوعة": "Mixed Grain Crackers",
  "برازق السمسم بالخميرة الطبيعية 3درزن": "Sesame Barazek with Natural Yeast (3 Dozen)",
  "البرازق بالفول السودانى": "Peanut Barazek",
  "الغريبة بالهيل": "Gharaiba with Cardamom",
  "غريبة بالدراسين": "Cinnamon Gharaiba",
  "معمول تمر صغير خالٍ من الجلوتين": "Small Gluten-Free Date Maamoul",
  "بيتي فور أربع حبوب خالٍ من الجلوتين": "Gluten-Free Four-Grain Petit Fours",
  "بيتي فور بالشوكولاتة الداكنة خالٍ من الجلوتين": "Gluten-Free Dark Chocolate Petit Four",
  "بيتي فور باللوز خالٍ من الجلوتين": "Gluten-Free Almond Petit Four",
  "بيتي فور بالتين خالٍ من الجلوتين": "Gluten-Free Fig Petit Four",
  "بيتي فور بجوز الهند خالٍ من الجلوتين": "Gluten-Free Coconut Petit Four",
  "بيتي فور بزبدة الفول السوداني خالٍ من الجلوتين": "Gluten-Free Peanut Butter Petit Four",
  "بيتي فور بالزبيب خالٍ من الجلوتين": "Gluten-Free Raisin Petit Four",
  "بيتي فور بعجينة المشمش – خالٍ من الجلوتين": "Apricot Paste Petit Four – Gluten-Free",
  "بيتي فور بالمكسرات خالٍ من الجلوتين": "Gluten-Free Nut Petit Four",
  "بيتي فور بالجوز خالٍ من الجلوتين": "Gluten-Free Walnut Petit Fours",
  "برازق بالسمسم خالية من الجلوتين": "Gluten-Free Sesame Barazek",
  "غريبة الدارسين خالي من الجلوتين": "Gluten-Free Cinnamon Ghraybeh",
  "غريبة بالهيل والأرز الأسمر خالية من الجلوتين": "Gluten-Free Cardamom Ghraybeh with Brown Rice",
  "بسكويت باليانسون خالٍ من الجلوتين": "Gluten-Free Anise Biscuits",
  "بسكويت بجوز الهند والأرز البني والشوكولاتة الداكنة": "Brown Rice Coconut Dark Chocolate Biscuits",
  "بسكويت كيتو صغير بجوز الهند (شكل قلب)": "Small Keto Coconut Biscuits (Heart)",
  "بسكويت الهيل بالرز الأسمر الخالي من الجلوتين": "Gluten-Free Cardamom and Brown Rice Biscuits",
  "بسكويت الدارسين الخالي من الجلوتين": "Gluten-Free Cinnamon Biscuits",
  "بقصم الينسون خالي من الجلوتين": "Gluten-Free Anise Rusks",
  "بقصم الزعتر خالي من الجلوتين": "Gluten-Free Thyme Rusks",
  "حلوى الرياضيين بالفواكه المجففة حبوب كاملة": "Athlete’s Energy Bar with Dried Fruits and Whole Grains",
  "حلوى الرياضيين بالشكولاتة الداكنة حبوب كاملة": "Athlete’s Energy Bar with Dark Chocolate and Whole Grains",
  "حلوى الرياضيين بالتمر حبوب كاملة": "Whole Grain Date Energy Bars for Athletes",
  "حلوى الرياضيين بالعسل حبوب كاملة": "Athlete’s Energy Bar with Honey and Whole Grains",
  "حلوى الرياضيين بالشيكولاتة الداكنة الخالي من الجلوتين": "Gluten-Free Dark Chocolate Energy Bar for Athletes",
  "حلوي الرياضيين بالتمر الخالي من الجلوتين": "Gluten-Free Date Energy Bar for Athletes",
  "حلوى الرياضيين بالعسل الخالي من الجلوتين": "Gluten-Free Honey Energy Bar for Athletes",
  "حلوي الرياضيين بالفواكه المجففة الخالي من الجلوتين": "Gluten-Free Dried Fruit Energy Bar for Athletes",
  "بسكويت موالح الكيتو": "Keto Savory Biscuits-Mawalyah"
};

  let yarmookOrders = {};
  let abuOrders = {};

  const yarmookSection = document.getElementById("yarmookSection");
  const abuSection = document.getElementById("abuSection");
  const yarmookSendBtn = document.getElementById("yarmookSendBtn");
  const abuSendBtn = document.getElementById("abuSendBtn");

  function renderBranchOrders(branchOrders, container, branchName) {
    container.innerHTML = "";
    for (const [productName, { requested, added, date, ids }] of Object.entries(branchOrders)) {
      const remainingQty = requested - added;
      const productEn = translations[productName] || "";

      const card = document.createElement("div");
      card.classList.add("product-card");
      if (remainingQty > 0) card.classList.add("red");
      else card.classList.add("green");
      card.setAttribute("data-product", productName);

      card.innerHTML = `
        <div class="product-info">
          <div>${productName} <span>${productEn}</span></div>
          <div>الكمية المطلوبة | Requested: ${requested}</div>
          <div>
            الكمية المضافة | Added: 
            <input type="number" min="0" max="${requested}" value="${added}" class="editable-added" />
          </div>
          <div class="date">${new Date(date).toLocaleString("ar-EG")}</div>
        </div>`;

      container.appendChild(card);

      // حدث تعديل الكمية المضافة
      const addedInput = card.querySelector(".editable-added");
      addedInput.addEventListener("change", async (e) => {
        let newAdded = parseInt(e.target.value);
        if (isNaN(newAdded) || newAdded < 0) {
          alert("الرجاء إدخال رقم صحيح أكبر أو يساوي صفر");
          e.target.value = added;
          return;
        }
        if (newAdded > requested) {
          alert("الكمية المضافة لا يمكن أن تزيد عن الكمية المطلوبة");
          e.target.value = added;
          return;
        }

        // تحديث البيانات في الذاكرة مؤقتًا
        branchOrders[productName].added = newAdded;

        // تحديث الكمية في Firebase
        // ابحث عن جميع الطلبات التي تحتوي هذا المنتج ضمن هذا الفرع وحدث الكمية المضافة
        const ordersRef = ref(db, "orders");
        onValue(ordersRef, (snapshot) => {
          snapshot.forEach(async (childSnap) => {
            const order = childSnap.val();
            const key = childSnap.key;
            if(order.branch === branchName && order.order && order.order[productName] !== undefined){
              // حدث الكمية المضافة ضمن حقل "added" (يجب أن تكون موجودة ضمن بياناتك)
              // إن لم تكن موجودة ضمن البيانات الأصلية، يمكن حفظها ضمن حقل جديد تحت الطلب.
              // هنا مثال بسيط: تخزين الكمية المضافة داخل حقل "addedOrder"
              // يمكنك تعديل ذلك حسب هيكل بياناتك
              await update(ref(db, `orders/${key}`), {
                [`addedOrder/${productName}`]: newAdded
              });
            }
          });
        }, { onlyOnce: true });

        // إعادة عرض الطلبات لتحديث الواجهة
        renderBranchOrders(branchOrders, container, branchName);
      });
    }
  }

  function sendWhatsApp(branchName, branchOrders) {
    const greenProducts = [];
    const redProducts = [];

    for(const [productName, {requested, added}] of Object.entries(branchOrders)){
      const en = translations[productName] || "";
      if(added > 0){
        greenProducts.push(`${productName} (${en}) - ${added}`);
      }
      const remaining = requested - added;
      if(remaining > 0){
        redProducts.push(`${productName} (${en}) - ${remaining}`);
      }
    }

    const message = `مرحباً، فرع ${branchName} | Hello, branch ${branchName}\n` +
      "المنتجات التي سيتم ارسالها اليوم هي التالي: | Products to be sent today:\n" +
      greenProducts.join("\n") + "\n" +
      "---------\n" +
      "المنتجات التي سيتم ارسالها عند التجهيز: | Products to be sent later:\n" +
      redProducts.join("\n");

    const encodedMsg = encodeURIComponent(message);

    let phone = "";
    if(branchName === "يرموك") phone = "96565162277";
    else if(branchName === "أبو الحصانية") phone = "96599176512";

    window.open(`https://wa.me/${phone}?text=${encodedMsg}`, "_blank");

    for(const productName in branchOrders){
      branchOrders[productName].requested -= branchOrders[productName].added;
      if(branchOrders[productName].requested < 0) branchOrders[productName].requested = 0;
      branchOrders[productName].added = 0;
    }

    if(branchName === "يرموك") renderBranchOrders(yarmookOrders, yarmookSection, "يرموك");
    else if(branchName === "أبو الحصانية") renderBranchOrders(abuOrders, abuSection, "أبو الحصانية");
  }

  yarmookSendBtn.addEventListener("click", () => sendWhatsApp("يرموك", yarmookOrders));
  abuSendBtn.addEventListener("click", () => sendWhatsApp("أبو الحصانية", abuOrders));

  function fetchOrders() {
    const ordersRef = ref(db, 'orders');
    onValue(ordersRef, (snapshot) => {
      yarmookOrders = {};
      abuOrders = {};
      snapshot.forEach(childSnap => {
        const order = childSnap.val();
        const branch = order.branch;
        const orderObj = order.order;
        const timestamp = order.timestamp || Date.now();

        for (const [productName, qty] of Object.entries(orderObj)) {
          if(qty <= 0) continue;
          let targetOrders = null;
          if(branch === "يرموك") targetOrders = yarmookOrders;
          else if(branch === "أبو الحصانية") targetOrders = abuOrders;
          else return;

          if(!targetOrders[productName]){
            // نقرأ "added" من حقل "addedOrder" لو موجود، أو صفر
            const addedQty = (order.addedOrder && order.addedOrder[productName]) || 0;
            targetOrders[productName] = {
              requested: qty,
              added: addedQty,
              date: timestamp,
              ids: []
            };
          } else {
            targetOrders[productName].requested += qty;
            // تحديث الكمية المضافة حسب الحاجة
            const addedQty = (order.addedOrder && order.addedOrder[productName]) || 0;
            targetOrders[productName].added += addedQty;
          }
        }
      });

      renderBranchOrders(yarmookOrders, yarmookSection, "يرموك");
      renderBranchOrders(abuOrders, abuSection, "أبو الحصانية");
    });
  }

  window.onload = () => {
    fetchOrders();
  }
</script>
</head>
<body>

<header>متابعة نواقص الفروع | Branch Shortage Tracking</header>

<div class="branches-container">

  <section class="branch-section" id="yarmookBranch">
    <h2>نواقص فرع اليرموك | Yarmook Branch Shortages</h2>
    <div id="yarmookSection"></div>
    <button id="yarmookSendBtn" class="whatsapp-btn">ارسال نواقص اليرموك | Send Yarmook Shortages</button>
  </section>

  <section class="branch-section" id="abuBranch">
    <h2>نواقص فرع ابو الحصانية | Abu Al-Hasania Branch Shortages</h2>
    <div id="abuSection"></div>
    <button id="abuSendBtn" class="whatsapp-btn">ارسال نواقص ابو الحصانية | Send Abu Al-Hasania Shortages</button>
  </section>

</div>

</body>
</html>
