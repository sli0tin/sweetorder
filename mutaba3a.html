<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>متابعة نواقص الفروع</title>
  <style>
    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      margin: 0; padding: 0;
      background: #f4f4f4;
      direction: rtl;
    }
    header {
      background: #fff;
      padding: 20px;
      text-align: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      position: relative;
    }
    .lang-switch {
      position: absolute;
      top: 10px;
      left: 10px;
      cursor: pointer;
      padding: 6px 10px;
      border: 1px solid #888;
      border-radius: 6px;
      background: #eee;
      user-select: none;
    }
    .branches-container {
      display: flex;
      flex-direction: row;
      justify-content: space-between;
      padding: 20px;
      gap: 10px;
    }
    .branch-section {
      flex: 1;
      background: #fff;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      max-height: 80vh;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      position: relative;
    }
    .branch-section h2 {
      text-align: center;
      margin-top: 0;
    }
    .product-card {
      border: 1px solid #ccc;
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: default;
    }
    .product-card.red {
      background-color: #fdd;
    }
    .product-card.green {
      background-color: #dfd;
    }
    .product-info {
      text-align: right;
      max-width: 75%;
    }
    .product-info .en {
      font-size: 0.85rem;
      color: #555;
      font-style: italic;
    }
    .product-info .qty, .product-info .date {
      font-size: 0.85rem;
      color: #333;
      margin-top: 4px;
    }
    .add-btn {
      background: #3498db;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 0.9rem;
      cursor: pointer;
      user-select: none;
      transition: background-color 0.3s ease;
    }
    .add-btn:hover {
      background-color: #2980b9;
    }
    .whatsapp-btn {
      margin-top: auto;
      background: #25d366;
      color: white;
      border: none;
      padding: 12px;
      font-size: 1rem;
      border-radius: 8px;
      cursor: pointer;
      align-self: center;
      width: 90%;
      max-width: 250px;
    }
    #alarmSound {
      display: none;
    }
    #stopAlarmBtn {
      position: fixed;
      bottom: 20px;
      left: 20px;
      padding: 10px 20px;
      background: red;
      color: white;
      font-size: 1rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      display: none;
      z-index: 10001;
    }
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const app = initializeApp({
      apiKey: "AIzaSyBoUv5YTd2ZalQ_mdkOVZF13ps_XYvmtBk",
      authDomain: "shortage-tracker-f0054.firebaseapp.com",
      projectId: "shortage-tracker-f0054",
      storageBucket: "shortage-tracker-f0054.appspot.com",
      messagingSenderId: "61596664058",
      appId: "1:61596664058:web:77ee76208afe58a0b20943"
    });

    const db = getFirestore(app);

    const alarmSound = document.getElementById("alarmSound");
    const stopAlarmBtn = document.getElementById("stopAlarmBtn");
    const langSwitch = document.getElementById("langSwitch");
    const yarmookTitle = document.getElementById("yarmookTitle");
    const abuTitle = document.getElementById("abuTitle");
    const yarmookBtn = document.getElementById("yarmookBtn");
    const abuBtn = document.getElementById("abuBtn");

    let lang = "ar";
    const texts = {
      ar: {
        yarmook: "نواقص فرع اليرموك",
        abu: "نواقص فرع أبو الحصانية",
        sendYarmook: "إرسال نواقص اليرموك",
        sendAbu: "إرسال نواقص أبو الحصانية",
        stopAlarm: "إيقاف التنبيه",
        langSwitch: "English"
      },
      en: {
        yarmook: "Yarmook Branch Shortages",
        abu: "Abu Al-Hasaniya Branch Shortages",
        sendYarmook: "Send Yarmook Shortages",
        sendAbu: "Send Abu Shortages",
        stopAlarm: "Stop Alarm",
        langSwitch: "العربية"
      }
    };

    function updateTexts() {
      document.documentElement.lang = lang;
      document.documentElement.dir = lang === "ar" ? "rtl" : "ltr";
      langSwitch.textContent = texts[lang].langSwitch;
      yarmookTitle.textContent = texts[lang].yarmook;
      abuTitle.textContent = texts[lang].abu;
      yarmookBtn.textContent = texts[lang].sendYarmook;
      abuBtn.textContent = texts[lang].sendAbu;
      stopAlarmBtn.textContent = texts[lang].stopAlarm;
    }

    langSwitch.onclick = () => {
      lang = lang === "ar" ? "en" : "ar";
      updateTexts();
    };

    let isFirstLoad = true;
    let prevYarmookIds = [];
    let prevAbuIds = [];

    function playAlarm() {
      alarmSound.play();
      stopAlarmBtn.style.display = "block";
    }

    stopAlarmBtn.onclick = () => {
      alarmSound.pause();
      alarmSound.currentTime = 0;
      stopAlarmBtn.style.display = "none";
    };

    function checkNewData(snapshot, prevIds) {
      const currentIds = snapshot.docs.map(doc => doc.id);
      const hasNew = currentIds.some(id => !prevIds.includes(id));
      return { currentIds, hasNew };
    }

    onSnapshot(collection(db, "yarmook"), snapshot => {
      const { currentIds, hasNew } = checkNewData(snapshot, prevYarmookIds);
      if (!isFirstLoad && hasNew) playAlarm();
      prevYarmookIds = currentIds;
    });

    onSnapshot(collection(db, "abuhasaniya"), snapshot => {
      const { currentIds, hasNew } = checkNewData(snapshot, prevAbuIds);
      if (!isFirstLoad && hasNew) playAlarm();
      prevAbuIds = currentIds;
      isFirstLoad = false;
    });

    updateTexts();
  </script>
</head>
<body>
  <header>
    <button id="langSwitch" class="lang-switch">English</button>
  </header>
  <div class="branches-container">
    <div class="branch-section">
      <h2 id="yarmookTitle">نواقص فرع اليرموك</h2>
      <div id="yarmookList"></div>
      <button id="yarmookBtn" class="whatsapp-btn">إرسال نواقص اليرموك</button>
    </div>
    <div class="branch-section">
      <h2 id="abuTitle">نواقص فرع أبو الحصانية</h2>
      <div id="abuList"></div>
      <button id="abuBtn" class="whatsapp-btn">إرسال نواقص أبو الحصانية</button>
    </div>
  </div>

  <audio id="alarmSound" src="alarm.mp3" loop></audio>
  <button id="stopAlarmBtn">إيقاف التنبيه</button>
</body>
</html>
